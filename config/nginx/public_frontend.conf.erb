access_log <%= current_path %>/log/access.log combined;
error_log <%= current_path %>/log/error.log;

# Limit the number of simulaneous connections per IP address to 50.
limit_conn api_umbrella_conn_addr_zone 50;

# After the 100 requests/second rate is reached, allow a sizable burst before
# completely terminating requests at this router level. This is so we can
# generally rely on API Umbrella Gatekeeper for rate limiting, but still
# throttle traffic to the Gatekeeper.
limit_req zone=api_umbrella_req_addr_zone burst=100 nodelay;

keepalive_timeout 30s;

# Proxy over HTTP 1.1 so keepalive connections to the backend are supported.
proxy_http_version 1.1;

# Default headers - Note these will only be inherited if no location specific
# headers are set.
include <%= latest_release %>/config/nginx/default_proxy_headers.conf;

location / {
  set $x_api_umbrella_uid $request_id;
  set $router_name "web_router";
  access_log <%= current_path %>/log/router.log api_umbrella_log;

  include <%= latest_release %>/config/nginx/default_proxy_headers.conf;
  proxy_set_header X-Api-Umbrella-UID $request_id;
  proxy_pass http://api_umbrella_gatekeeper_backend;
}
