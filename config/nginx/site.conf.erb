include <%= latest_release %>/config/nginx/ssl_terminator.conf;

upstream github_pages_backend {
  server nrel.github.io:80;
  keepalive 10;
}

upstream api_umbrella_web_backend {
  server 127.0.0.1:51000;
  keepalive 10;
}

upstream api_umbrella_gatekeeper_frontend {
  server 127.0.0.1:50090;
  keepalive 10;
}

include <%= current_path %>/config/gatekeeper/nginx*.conf;

server {
  listen 80;
  server_name <%= all_domains.join(" ") %>;

  access_log <%= current_path %>/log/access.log combined;
  error_log <%= current_path %>/log/error.log;

  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

  # Proxy over HTTP 1.1 so keepalive connections to the backend are supported.
  proxy_http_version 1.1;
  proxy_set_header Connection "";

  # Conditional proxy headers. Don't set these x-forwarded headers if they've
  # already been set (by the SSL terminator).
  set $real_scheme $http_x_forwarded_proto;
  if ($real_scheme = "") {
    set $real_scheme $scheme; 
  }

  set $real_port $http_x_forwarded_port;
  if ($real_port = "") {
    set $real_port $server_port; 
  }

  proxy_set_header X-Forwarded-Proto $real_scheme;
  proxy_set_header X-Forwarded-Port $real_port;

  location ~* ^/(about|community|doc|docs|images|static|)(/|$) {
    rewrite ^/doc(/|$) /docs/ permanent;

    proxy_set_header Host "api.data.gov";
    proxy_set_header Connection ""; # Proxy over HTTP 1.1 w keepalive.
    proxy_pass http://github_pages_backend;
  }

  location ~* ^/(account|admin|admins|assets|contact|favicon\.ico|javascripts|robots.txt|signup)(/|$) {
    proxy_pass http://api_umbrella_web_backend;
  }

  location / {
    # Remove the legacy /api/ prefix from all API urls. Now we assume API URLs
    # are all top-level.
    rewrite ^/api(/.*) $1 break;

    proxy_pass http://api_umbrella_gatekeeper_frontend;
  }
}
